<%inherit file="base_with_menu.html" />
<%block name="head">
<script type="text/javascript">
        update_interval=5000
        last_update = 0
        function timed_update() {
            now = Date.now();
            if(now-last_update>update_interval)
                update();
            setTimeout(timed_update,update_interval);
        }

        function update() {
            last_update = Date.now();
            $.ajax({
                type:'POST',
                url:'${dataset_path}/',
                dataType: 'json',
                success: function(msg) {
                    $('#datasets\\_list div .dataset\\_name').each(function(i,item) {
                        var found = false;
                        for(var i = 0;i<msg.length;++i) {
                            if($(item).text()==msg[i].name) {
                                found = true;
                                break;
                            }
                        }
                        if(!found) {
                            $(item).parent().remove();
                        }
                    });
                    if(msg.length==0) {
                        $('#datasets\\_list').html('<div class="padded ui-widget-header ui-corner-all">No dataset available</div>');
                    }
                    else {
                        if($('#_gotdatasets').length==0)
                            $('#datasets\\_list').html('<div id="_gotdatasets" class="padded ui-widget-header ui-corner-all">Avalilable datasets:</div>');
                        for(var i = 0;i<msg.length;++i) {
                            var datasetdiv = jQuery('<div class=\'padded margined ui-widget-content hideoverflow\' id=\'dataset_'+msg[i].name+'\'>\
                            <div id=\'dataset_name_'+msg[i].name+'\' class=\'inline padded ui-corner-all dataset_name\'>'+msg[i].name+'</div>\
                            <div id=\'del_button_'+msg[i].name+'\' class=\'right\'>Delete</div>\
                            <div id=\'rename_button_'+msg[i].name+'\' class=\'right\'>Rename</div>\
                            <div id=\'download_button_'+msg[i].name+'\' class=\'right\'>Download</div>\
                            <div id=\'upload_button_'+msg[i].name+'\' class=\'right\'>Select for upload</div>\
                            <div id=\'classify_button_'+msg[i].name+'\' class=\'right\'>Classify</div>\
                            <div id=\'browse_button_'+msg[i].name+'\' class=\'right\'>Browse &amp; label</div>\
                            <div class="small margined">Size: '+msg[i].size+'</div>\
                            <div class="small margined">Created: '+msg[i].created+'</div>\
                            <div class="small margined">Updated: '+msg[i].updated+'</div></div>');
                            if($('#dataset\\_'+msg[i].name).length==0) {
                                $('#datasets\\_list').append(datasetdiv)
                            }
                            else {
                                $('#dataset\\_'+msg[i].name).replaceWith(datasetdiv)
                            }
                            $('#browse\\_button\\_'+msg[i].name).button({ icons: {primary:'ui-icon-search'} });
                            $('#browse\\_button\\_'+msg[i].name).click(
                                (function() {
                                    var dataset_name = msg[i].name;
                                    return function() {
                                        window.location.href = '/browseandlabel/'+dataset_name;
                                    }
                            })());
                            $('#classify\\_button\\_'+msg[i].name).button({ icons: {primary:'ui-icon-tag'} });
                            $('#classify\\_button\\_'+msg[i].name).click(
                                (function() {
                                    var dataset_name = msg[i].name;
                                    return function() {
                                        window.location.href = '/classify/'+dataset_name;
                                    }
                            })());
                            $('#upload\\_button\\_'+msg[i].name).button({ icons: {primary:'ui-icon-arrowthick-1-n'} });
                            $('#upload\\_button\\_'+msg[i].name).click(
                                (function() {
                                    var dataset_name = msg[i].name;
                                    return function() {
                                        $('#name').val(dataset_name);
                                        $('#dataset\\_upload').effect("bounce", {'distance':'5', 'times':'2'}, 200)
                                    }
                            })());
                            $('#download\\_button\\_'+msg[i].name).button({ icons: {primary:'ui-icon-arrowthickstop-1-s'} });
                            $('#download\\_button\\_'+msg[i].name).click(download_dataset);
                            $('#rename\\_button\\_'+msg[i].name).button({ icons: {primary:'ui-icon-tag'} });
                            $('#rename\\_button\\_'+msg[i].name).click(rename_dataset);
                            $('#del\\_button\\_'+msg[i].name).button({ icons: {primary:'ui-icon-trash'} });
                            $('#del\\_button\\_'+msg[i].name).click(delete_dataset);
                        }
                        $('#datasets\\_list').append($('#datasets\\_list > div').get().sort(function (a, b) {
                            return $(a)[0].id.localeCompare($(b)[0].id);
                        }));
                    }
                }
            });
        }

        function upload_dataset() {
            $( "#upload\\_button" ).button( "option", "disabled", true );
            name = $("#name").val();
            if(!name.match(/^[a-zA-Z0-9_]+$/)) {
                custom_alert("The name of the dataset can only contain letters, numbers and the underscore character '_'");
            delay(function() {$( "#upload\\_button" ).button( "option", "disabled", false );},2000);
                return false;
            }
            if($('#dataFile')[0].files.length!=1) {
                custom_alert("Must select a file.");
                delay(function() {$( "#upload\\_button" ).button( "option", "disabled", false );},2000);
                return false;
            }
            var data = new FormData()
            data.append("file", $('#dataFile')[0].files[0]);
            data.append("name", name);
            $.ajax({
                type: "POST",
                url: "${dataset_path}/upload",
                data: data,
                enctype: 'multipart/form-data',
                processData: false,
                contentType: false})
            .done(update)
            .fail(function(errMsg) {
                    custom_alert(errMsg.responseText);
            });
            delay(function() {$( "#upload\\_button" ).button( "option", "disabled", false );},2000);
            return false ;
        };

        function rename_dataset() {
            var dataset_name = $(this).siblings('.dataset\\_name').text();
            var rename_dialog =  jQuery('<div class=\'padded margined ui-widget-content hideoverflow\' id=\'rename_dataset_'+dataset_name+'\'><input id="rename_new_name_'+dataset_name+'" type="text"></div>');
            rename_dialog.dialog({modal:true,
                                    title:'Rename dataset',
                                    width: $(window).width()*0.5,
                                    buttons: {
                                        'Rename': function() {
                                            var new_name = $('#rename\\_new\\_name\\_'+dataset_name).val()
                                            if(!new_name.match(/^[a-zA-Z0-9_]+$/)) {
                                                custom_alert("The name of the dataset can only contain letters, numbers and the underscore character '_'");
                                                return false;
                                            }
                                            $.ajax({
                                                type: "POST",
                                                url: "${dataset_path}/rename/"+dataset_name+"/"+new_name})
                                            .done(update)
                                            .fail(function(errMsg) {
                                                custom_alert(errMsg.responseText);
                                            });
                                            $(this).dialog('close');
                                        },
                                        'Cancel': function() {
                                            $(this).dialog('close');
                                        }
                                    },
                                  });
        };

        function delete_dataset() {
            if(!confirm('Please confirm the DELETE request, proceed?'))
                return;
            var dataset_name = $(this).siblings('.dataset\\_name').text();
            $('#dataset\\_'+dataset_name).hide();
            $.ajax({
                type:'POST',
                url:'${dataset_path}/delete/'+dataset_name})
            .done(update)
            .fail(function () {
                    $('#dataset\\_'+dataset_name).show();
            });
        };

        function download_dataset() {
            var dataset_name = $(this).siblings('.dataset\\_name').text();
            var form = $('<form></form>').attr('action', '${dataset_path}/download/'+dataset_name).attr('method', 'post');
            form.appendTo('body').submit().remove();
        };

        $( document ).ready(function() {

            $("#upload\\_form").submit(upload_dataset);

            //$('#force\\_update').button().click(update);
            $( "input[type=submit]" ).button();
            $( "input[type=file]" ).button();
            timed_update();
        });



</script>
</%block>

<div id="main" class="padded ui-widget ui-widget-content">
    <div id="sidebar">
        <!--<div class="padded ui-corner-all ui-widget ui-widget-content" id="force_update">Force update
        </div>-->
        <div class="margined  ui-corner-all ui-widget ui-widget-content" id="dataset_upload">
            <div class="padded ui-widget-header ui-corner-all">Upload documents to a dataset (create if missing):</div>
            <form enctype="multipart/form-data" id="upload_form" class="margined" action="#" method="post">
                <p><label for="name">Dataset name:</label><input type="text" id="name"/></p>

                <p><label>Data file:</label><input type="file" id="dataFile"/></p>

                <p><label></label><input id="upload_button" type="submit" value="Upload"/></p>
            </form>
        </div>
    </div>
    <div id="center">
        <div class="margined ui-corner-all ui-widget ui-widget-content" id="datasets_list">
        </div>
    </div>
</div>
