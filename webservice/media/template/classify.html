<%inherit file="basewithmenu.html" />
<%block name="head">
${parent.head()}
    <script type="text/javascript">
       update_interval=5000
       delay_interval=500
        last_update = 0
        page = 1;
        page_size = 10;

        pagination_div = jQuery('<div id="pagination" class="right plain">\
                         page<input id="page" style="width:3em;" type="number" min="1" value="1"/>\
                         /<span id="pagecount">X</span>\
                         count<select id="pagesize"><option value="10" selected>10</option>\
                         <option value="20">20</option><option value="50" >50</option>\
                         <option value="100">100</option><option value="200">200</option></select></div></div>');

        function timed_update() {
            now = Date.now();
            if(now-last_update>update_interval)
                update();
            setTimeout(timed_update,update_interval);
        }

        datasetname = 'NULL';

        function update() {
            last_update = Date.now();
            var count = parseInt($(pagination_div.children()[2]).val())
            $.ajax({
                type:'POST',
                url:'${dataset_path}/get_classification_jobs_count',
                data: { name : datasetname},
                dataType: 'json'})
            .done(function(msg) {
                count = parseInt(msg);
                var maxpage = Math.ceil(count/parseInt($(pagination_div.children()[2]).val()))
                $(pagination_div.children()[0]).attr({
                       "max" : maxpage
                    });
                $(pagination_div.children()[1]).text(maxpage)
            });
            $.ajax({
                type:'POST',
                url:'${dataset_path}/get_classification_jobs',
                data: { name : datasetname, page : parseInt($(pagination_div.children()[0]).val())-1, page_size :$(pagination_div.children()[2]).val()},
                dataType: 'json'})
            .done(function(msg) {
                if(msg.length==0) {
                    $('#classification').html('<div id="nodata" class="padded ui-widget-header ui-corner-all">No classification available for dataset \''+datasetname+'\'</div>');
                    $('#nodata').prepend(pagination_div);
                    $('#page').val(1);
                }
                else {
                    if($('#gotdata').length==0) {
                        $('#classification').html('<div id="gotdata" class="padded ui-widget-header ui-corner-all">Classifications for dataset \''+datasetname+'\':</div>\
                        <div id="job" class="table margined ui-widget-content ui-corner-all"><div><div>id</div><div>classifiers</div><div>created</div><div>completed</div><div>status</div><div>actions</div></div></div>');
                        $('#gotdata').prepend(pagination_div);
                    }
                    var curr_list = {};
                    $('#job').children().each(function (index, value) {if(value.id.startsWith('job_')) { curr_list[value.id]=true;}});
                    for(var i = 0;i<msg.length;++i) {
                        item = jQuery('<div id=\'job_'+msg[i].id+'\'>\
                        <div class="id">'+msg[i].id+'</div>\
                        <div>'+msg[i].classifiers+'</div>\
                        <div>'+msg[i].creation+'</div>\
                        <div>'+msg[i].completion+'</div>\
                        <div>'+msg[i].status+'</div>\
                        <div><div id="download_'+msg[i].id+'">Download</div>\
                        <div id="delete_'+msg[i].id+'">Delete</div></div>\
                        </div>');
                        if ($('#job\\_'+msg[i].id).length!=0) {
                            $('#job\\_'+msg[i].id).replaceWith(item);
                            delete curr_list['job_'+msg[i].id];
                        }
                        else
                            $('#job').append(item);
                        $('#delete\\_'+msg[i].id).button({ icons: {primary:'ui-icon-trash'} });
                        $('#delete\\_'+msg[i].id).click(delete_classification);
                        $('#download\\_'+msg[i].id).button({ icons: {primary:'ui-icon-arrowthickstop-1-s'} });
                        $('#download\\_'+msg[i].id).click(download_classification);
                    }
                    for (var key in curr_list) {
                        $('#'+key).remove();
                    }
                }
                $('#page').unbind('keyup mouseup');
                $('#pagesize').unbind('keyup mouseup');
                $('#page').bind('keyup mouseup',update);
                $('#pagesize').bind('keyup mouseup',update);
            });

            $.ajax({
                type:'POST',
                url:'${classifier_path}/info',
                dataType: 'json'})
            .done(function(msg) {
                    $('#classifiers\\_list div .classifier\\_name').each(function(i,item) {
                        var found = false;
                        for(var i = 0;i<msg.length;++i) {
                            if($(item).text()==msg[i].name) {
                                found = true;
                                break;
                            }
                        }
                        if(!found) {
                            $('#suggestions\\_'+$(item).text()).remove();
                            $(item).parent().remove();
                        }
                    });
                    if(msg.length==0) {
                        $('#classifiers\\_list').html('<div class="padded ui-widget-header ui-corner-all">No classifiers available</div>');
                    }
                    else {
                        if($('#gotclassifiers').length==0)
                            $('#classifiers\\_list').html('<div id="gotclassifiers" class="padded ui-widget-header ui-corner-all">Select classifiers:</div>');
                        for(var i = 0;i<msg.length;++i) {
                            if($('#classifier\\_'+msg[i].name).length==0) {
                                $('#classifiers\\_list').append('<div class=\'padded margined ui-widget-content hideoverflow\' id=\'classifier_'+msg[i].name+'\' title="'+msg[i].description+'">\
                                <div id=\'classifier_name_'+msg[i].name+'\' class=\' inline padded  ui-corner-all left classifier_name\' style=\'vertical-align: middle;\'>'+msg[i].name+'</div>\
                                <div id=\'use_button_'+msg[i].name+'\' class=\'right\'>Use</div>\
                                </div>');
                                $('#use\\_button\\_'+msg[i].name).button({ icons: {primary:'ui-icon-plus'} });
                                $('#use\\_button\\_'+msg[i].name).click(
                                    (function() {
                                        var classifier_name = msg[i].name;
                                        return function() {
                                            var classifier_item = $(this).siblings('.classifier\\_name');
                                            var classifier_name = classifier_item.text();
                                            var item = $('#use\\_button\\_'+classifier_name);
                                            if(classifier_item.hasClass('ui-state-highlight')) {
                                                classifier_item.removeClass('ui-state-highlight');
                                                item.removeClass('ui-state-focus');
                                                item.button({icons: {primary :'ui-icon-plus'}});
                                            }
                                            else {
                                                classifier_item.addClass('ui-state-highlight');
                                                item.addClass('ui-state-focus');
                                                item.button({icons: {primary :'ui-icon-check'}});
                                            }
                                        }
                                })());
                            }
                        }
                        if($('#classify\\_button').length==0) {
                            $('#classifiers\\_list').append('<div id="classify_button">Classify the dataset</div>');
                            $('#classify\\_button').button({ icons: {primary:'ui-icon-tag'} });
                            $('#classify\\_button').click(classify);
                        }
                    }
            });
        }

        function delete_classification() {
            if(!confirm('Please confirm the DELETE request, proceed?'))
                return;
            var classification_id = $(this).parent().siblings('.id').text();
            $('#job\\_'+classification_id).hide();
            $.ajax({
                type:'POST',
                url:'${dataset_path}/delete_classification',
                data: { id : classification_id }})
            .done(update)
            .fail(function () {
                    $('#job\\_'+classification_id).show();
            });
        };

        function download_classification() {
            var classification_id = $(this).parent().siblings('.id').text();
            var form = $('<form></form>').attr('action', '${dataset_path}/download_classification/'+classification_id).attr('method', 'post');
            form.appendTo('body').submit().remove();
        };

        function classify() {
            classifiers = []
            $('.ui-state-highlight').each(function(i,item) {
                classifiers.push($(item).text());
            })
            $.ajax({
                type:'POST',
                url:'${dataset_path}/classify',
                data: { name : datasetname, classifiers : classifiers }})
            .done(update)
            .fail(function (msg) { custom_alert(msg.responseText);  });
        }


        $( document ).ready(function() {
            var pathname = window.location.pathname;
            datasetname = pathname.substring(pathname.lastIndexOf('/')+1)
            $('#datasetname').text(datasetname);

            $( "input[type=submit]" ).button();

            //$('#force\\_update').button().click(update);

            timed_update();
        });
    </script>
</%block>

<div id="main" class="padded ui-widget ui-widget-content">
    <div id="sidebar">
        <div class="margined ui-corner-all ui-widget ui-widget-content" id="classifiers_list">
        </div>
        <!--<div class="padded ui-corner-all ui-widget ui-widget-content" id="force_update">Force update
        </div>-->
    </div>
    <div id="center">
        <div id="classification" class="margined ui-widget-content suggestion-container"></div>
    </div>
</div>
