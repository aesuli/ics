<%inherit file="basewithmenu.html" />
<%block name="head">
${parent.head()}
<script type="text/javascript">
        update_interval=8000
        delay_interval=500
        last_update = 0
        function timed_update() {
            now = Date.now();
            if(now-last_update>update_interval)
                update();
            setTimeout(timed_update,update_interval);
        }

        datasetsize = 1;

        single = 'single';
        multi = 'multi';

        browse_diff = 'Optimized for ML';
        browse_next = 'Upload order';
        browse_prev = 'Reverse upload order';
        browse_random = 'Random unlabeled';
        browse_rnd = 'Random';

        autobrowsevalues = [
            [browse_diff,single],
            [browse_next,multi],
            [browse_prev,multi],
            [browse_random,multi],
            [browse_rnd,multi],
        ];

        autobrowse = 0;

        dataset_name = 'NULL';

        function set_uncoded_count(single_label, dataset_name, classifier_name) {
            $.ajax({
                type: 'POST',
                url: '${dataset_path}/documents_without_labels_count',
                data: { dataset_name : dataset_name , classifier_name:classifier_name}})
            .done( function (msg) {
                if (single_label) {
                    $('#use\\_opt\\_'+classifier_name).text(classifier_name+' (S, '+(datasetsize-parseInt(msg))+', '+msg+')');
                }
                else {
                    $('#use\\_opt\\_'+classifier_name).text(classifier_name+' (M, '+(datasetsize-parseInt(msg))+', '+msg+')');
                }
                $('#use').select2({
                    placeholder: 'Select the classifiers to use',
                    width: '100%'
                });
            });
        };

        function update() {
            last_update = Date.now();

            $.ajax({
                type: 'POST',
                url: '${dataset_path}/size',
                data: { name : dataset_name }})
            .done( function (msg) {
                    datasetsize = parseInt(msg);
                    $('#position').attr('max',datasetsize-1);
                    $('#size').text(datasetsize);
            });

            $.ajax({
                type:'POST',
                url:'${classifier_path}/info',
                dataType: 'json'})
            .done(function(msg) {
                    var updated_list = {};
                    var added = false;
                    for(var i = 0;i<msg.length;++i) {
                        var name_string = msg[i].name.replace(/\W/g,'X')
                        updated_list[name_string] = true;
                        if($('#use\\_opt\\_'+name_string).length==0) {
                            var single_label = msg[i].type=="Single-label";
                            var labeltype='<span id="'+name_string+'_single" class="w3-small w3-margin-left w3-right">S</span>';
                            if(!single_label) {
                                labeltype='<span id="'+name_string+'_multi" class="w3-small w3-margin-left w3-right">M</span>'
                            }
                            added = true;
                            $('#use').append($('<option title="'+msg[i].description+'" id="use_opt_'+name_string+'"/>').val(msg[i].name).text(msg[i].name));
                            $('#comb\\_from').append($('<option title="'+msg[i].description+'" id="comb_opt_'+name_string+'"/>').val(msg[i].name).text(msg[i].name));
                            var suggestion_div = jQuery('<div id=\'suggestions_'+msg[i].name+'\' class=\'w3-col w3-card w3-margin-top w3-margin-right\' style=\'width:auto\'>\
                            <div class="name w3-display-container w3-container w3-padding w3-theme">'+msg[i].name+labeltype+'</div>\
                            <div id="assignments_'+msg[i].name+'"></div></div>');
                            suggestion_div.appendTo('#pool');
                            set_uncoded_count(single_label, dataset_name, msg[i].name);
                            for(var j = 0;j<msg[i].labels.length;++j) {
                                if(single_label) {
                                    var scoreline = jQuery('<div id="suggestion_'+msg[i].name+'_L_'+msg[i].labels[j]+'" class="w3-left w3-hover-theme with w3-hover-opacity pointer scoreline not_relevant">'+msg[i].labels[j]+'</div>');
                                    scoreline.click((function(single_label, classifier_name, label){
                                        if(!$('#suggestion\\_'+classifier_name+'\\_L\\_'+label).hasClass('assigned')) {
                                            if($('#suggestion\\_'+classifier_name+'\\_L\\_'+label).hasClass('suggested')) {
                                                $('#history').prepend('<span class="agreement yes w3-text-light-green">✓</span>');
                                            }
                                            else {
                                                $('#history').prepend('<span class="agreement no w3-text-red">✗</span>');
                                            }
                                            var histsize = parseInt($("#histsize").val());
                                            $('#history').children().slice(histsize).remove();
                                            var total = $('#history').children().length;
                                            var positive = $('#history').children('.yes').length;
                                            $('#accuracy').text((positive/total*100).toFixed(0)+"%");

                                            $('#assignments\\_'+classifier_name).children('.scoreline').removeClass('suggested');
                                            $('#assignments\\_'+classifier_name).children('.scoreline').removeClass('assigned');
                                            $('#assignments\\_'+classifier_name).children('.scoreline').addClass('not_relevant');
                                            $('#suggestion\\_'+classifier_name+'\\_L\\_'+label).removeClass('not_relevant')
                                            $('#suggestion\\_'+classifier_name+'\\_L\\_'+label).addClass('assigned')
                                            $.ajax({
                                                type:'POST',
                                                url:'${classifier_path}/update',
                                                data: { name: classifier_name, X: [last_text], y: [label]}})
                                            .done((function(single_label, classifier_name) {
                                                setTimeout(function() {
                                                    set_uncoded_count(single_label, dataset_name, classifier_name);
                                                },1000);
                                            }).bind(null, single_label, classifier_name))
                                            .fail(function(msg) {
                                                custom_alert(msg);
                                            });
                                        }
                                    }).bind(null, single_label, msg[i].name, msg[i].labels[j]));
                                }
                                else {
                                    var scoreline_yes = jQuery('<div id="suggestion_'+msg[i].name+'_L_'+msg[i].labels[j]+'_yes" class="w3-col w3-hover-theme with w3-hover-opacity pointer scoreline not_relevant multiyes" style="width:auto;">'+msg[i].labels[j]+'</div>');
                                    var scoreline_no = jQuery('<div id="suggestion_'+msg[i].name+'_L_'+msg[i].labels[j]+'_no" class="w3-rest w3-hover-theme with w3-hover-opacity w3-right-align pointer scoreline not_relevant multino"">✗</div>');
                                    scoreline_yes.click((function(single_label, classifier_name, label){
                                        if(!$('#suggestion\\_'+classifier_name+'\\_L\\_'+label+'\\_yes').hasClass('assigned')) {
                                            if($('#suggestion\\_'+classifier_name+'\\_L\\_'+label+'\\_yes').hasClass('suggested')) {
                                                $('#history').prepend('<span class="agreement yes w3-text-light-green">✓</span>');
                                            }
                                            else {
                                                $('#history').prepend('<span class="agreement no w3-text-red">✗</span>');
                                            }
                                            var histsize = parseInt($("#histsize").val());
                                            $('#history').children().slice(histsize).remove();
                                            var total = $('#history').children().length;
                                            var positive = $('#history').children('.yes').length;
                                            $('#accuracy').text((positive/total*100).toFixed(0)+"%");

                                            $('#suggestion\\_'+classifier_name+'\\_L\\_'+label+'\\_yes').removeClass('not_relevant')
                                            $('#suggestion\\_'+classifier_name+'\\_L\\_'+label+'\\_yes').removeClass('suggested')
                                            $('#suggestion\\_'+classifier_name+'\\_L\\_'+label+'\\_yes').addClass('assigned')
                                            $('#suggestion\\_'+classifier_name+'\\_L\\_'+label+'\\_no').removeClass('assigned')
                                            $('#suggestion\\_'+classifier_name+'\\_L\\_'+label+'\\_no').removeClass('suggested')
                                            $('#suggestion\\_'+classifier_name+'\\_L\\_'+label+'\\_no').addClass('not_relevant')

                                            $.ajax({
                                                type:'POST',
                                                url:'${classifier_path}/update',
                                                data: { name: classifier_name, X: [last_text], y: [label+':yes']}})
                                            .done((function(single_label, classifier_name) {
                                                setTimeout(function() {
                                                    set_uncoded_count(single_label, dataset_name, classifier_name);
                                                },1000);
                                            }).bind(null, single_label, classifier_name))
                                            .fail(function(msg) {
                                                custom_alert(msg);
                                            });
                                        }
                                    }).bind(null, single_label, msg[i].name, msg[i].labels[j]));
                                    scoreline_no.click((function(single_label, classifier_name, label){
                                        if(!$('#suggestion\\_'+classifier_name+'\\_L\\_'+label+'\\_no').hasClass('assigned')) {
                                            if($('#suggestion\\_'+classifier_name+'\\_L\\_'+label+'\\_no').hasClass('suggested')) {
                                                $('#history').prepend('<span class="agreement yes w3-text-light-green">✓</span>');
                                            }
                                            else {
                                                $('#history').prepend('<span class="agreement no w3-text-red">✗</span>');
                                            }
                                            var histsize = parseInt($("#histsize").val());
                                            $('#history').children().slice(histsize).remove();
                                            var total = $('#history').children().length;
                                            var positive = $('#history').children('.yes').length;
                                            $('#accuracy').text((positive/total*100).toFixed(0)+"%");

                                            $('#suggestion\\_'+classifier_name+'\\_L\\_'+label+'\\_no').removeClass('not_relevant')
                                            $('#suggestion\\_'+classifier_name+'\\_L\\_'+label+'\\_no').removeClass('suggested')
                                            $('#suggestion\\_'+classifier_name+'\\_L\\_'+label+'\\_no').addClass('assigned')
                                            $('#suggestion\\_'+classifier_name+'\\_L\\_'+label+'\\_yes').removeClass('assigned')
                                            $('#suggestion\\_'+classifier_name+'\\_L\\_'+label+'\\_yes').removeClass('suggested')
                                            $('#suggestion\\_'+classifier_name+'\\_L\\_'+label+'\\_yes').addClass('not_relevant')

                                            $.ajax({
                                                type:'POST',
                                                url:'${classifier_path}/update',
                                                data: { name: classifier_name, X: [last_text], y: [label+':no']}})
                                            .done((function(single_label, classifier_name) {
                                                setTimeout(function() {
                                                    set_uncoded_count(single_label, dataset_name, classifier_name);
                                                },1000);
                                            }).bind(null, single_label, classifier_name))
                                            .fail(function(msg) {
                                                custom_alert(msg);
                                            });
                                        }
                                    }).bind(null, single_label, msg[i].name, msg[i].labels[j]));
                                    var scoreline = jQuery('<div class="w3-left w3-row multiscoreline"></div>');
                                    scoreline.append(scoreline_yes);
                                    scoreline.append(scoreline_no);
                                }
                                $('#assignments\\_'+msg[i].name).append(scoreline);
                            }
                        }
                    }
                    if($('#all\\_correct').length==0) {
                        var next_button = jQuery('<div id="next" class="w3-right w3-button w3-theme w3-round w3-margin-left" title="Press the right arrow key to move to next document">Next document</div>');
                        next_button.click(next_doc);
                        $('#buttons').append(next_button);
                        var all_correct = jQuery('<div id="all_correct" class="w3-right w3-button w3-theme w3-round">All <span class="suggested w3-text-theme">suggestions</span> are correct</div>');
                        all_correct.click(function() {
                            $('#suggestions div div .suggested').each(function(i,item) {
                                item.click();
                            });
                        });
                        if(!$('#showsugg').is(':checked')) {
                            all_correct.hide();
                            $('#historybox').hide();
                        }
                        $('#buttons').append(all_correct);
                    }
                    $('#use').children().each(function (index, value) {
                        if(!updated_list[value.id.slice(8)]) {
                            $('#'+value.id).remove();
                            $('#suggestions\\_'+value.id.slice(8)).remove();
                        }
                    });
                    $('#comb\\_from').children().each(function (index, value) {if(!updated_list[value.id.slice(9)]) {$('#'+value.id).remove();}});
                    if(added) {
                        $('#use').append($('#use > option').get().sort(function (a, b) {
                            return $(a)[0].id.localeCompare($(b)[0].id);
                        }));
                        $('#comb\\_from').append($('#comb\\_from > option').get().sort(function (a, b) {
                            return $(a)[0].id.localeCompare($(b)[0].id);
                        }));
                        $('#use').attr('size',Math.min(10,Object.keys(updated_list).length));
                        $("select[multiple]").off('select2:select').on('select2:select',function(msg){
                            var name = msg.params.data.id;
                            $('#suggestions\\_'+name).detach().appendTo('#suggestions');
                            classify([name]);
                            return false;
                        });
                        $("select[multiple]").off('select2:unselect').on('select2:unselect',function(msg){
                            var name = msg.params.data.id;
                            $('#suggestions\\_'+name).detach().appendTo('#pool');
                            return false;
                        });
                    }
            });
        }

        last_text = ""
        function classify(selection) {
            var text = $("#textbox").val();
            var force = text!=last_text;
            if(force) {
                reset_labels();
            }
            last_text = text;
            if($('#showsugg').is(':checked')) {
                $('#suggestions > div').each(function(i,item) {
                    var classifier_name = $(item).children('.name').text();
                    classifier_name = classifier_name.substr(0,classifier_name.length - 1)
                    var single_label = $('#'+classifier_name+'\\_single').length>0;
                    if(typeof selection == 'undefined' || selection.indexOf(classifier_name)>=0) {
                        if(single_label) {
                            var assigned = $('#assignments\\_'+classifier_name).children('.scoreline.assigned').length>0;
                            if(!assigned||force) {
                                $.ajax({
                                    type:'POST',
                                    url:'${classifier_path}/classify',
                                    data: { name: classifier_name, X: [text]}})
                                .done(function(msg) {
                                    var suggested = msg[0];
                                    assigned = $('#assignments\\_'+classifier_name).children('.scoreline.assigned').length>0;
                                    if(!assigned || force) {
                                        $('#assignments\\_'+classifier_name).children('.scoreline').removeClass('assigned');
                                        $('#assignments\\_'+classifier_name).children('.scoreline').removeClass('suggested');
                                        $('#assignments\\_'+classifier_name).children('.scoreline').addClass('not_relevant');
                                        if(suggested.startsWith('✍')) {
                                            var name = suggested.substring(1);
                                            $('#suggestion\\_'+classifier_name+'\\_L\\_'+name).removeClass('not_relevant');
                                            $('#suggestion\\_'+classifier_name+'\\_L\\_'+name).addClass('assigned');
                                        }
                                        else {
                                            $('#suggestion\\_'+classifier_name+'\\_L\\_'+suggested).removeClass('not_relevant');
                                            $('#suggestion\\_'+classifier_name+'\\_L\\_'+suggested).addClass('suggested');
                                        }
                                    }
                                });
                            }
                        }
                        else {
                            $.ajax({
                                type:'POST',
                                url:'${classifier_path}/classify',
                                data: { name: classifier_name, X: [text]}})
                            .done(function(msg) {
                                var suggested = msg[0];
                                suggested.forEach(function(label_value) {
                                    var split = label_value.split(':');
                                    var label = split[0];
                                    var value = split[1];
                                    var human = false;
                                    if(label.startsWith('✍')) {
                                        label = label.substring(1);
                                        human = true;
                                    }
                                    var not_value = (value=='yes')?'no':'yes';
                                    assigned = $('#suggestion\\_'+classifier_name+'\\_L\\_'+label+'\\_'+value).hasClass('assigned')||$('#suggestion\\_'+classifier_name+'\\_L\\_'+label+'\\_'+not_value).hasClass('assigned');
                                    if(!assigned || force) {
                                        $('#suggestion\\_'+classifier_name+'\\_L\\_'+label+'\\_'+value).removeClass('not_relevant');
                                        if(human) {
                                            $('#suggestion\\_'+classifier_name+'\\_L\\_'+label+'\\_'+value).addClass('assigned');
                                            $('#suggestion\\_'+classifier_name+'\\_L\\_'+label+'\\_'+value).removeClass('suggested');
                                        }
                                        else {
                                            $('#suggestion\\_'+classifier_name+'\\_L\\_'+label+'\\_'+value).addClass('suggested');
                                            $('#suggestion\\_'+classifier_name+'\\_L\\_'+label+'\\_'+value).removeClass('assigned');
                                        }
                                        $('#suggestion\\_'+classifier_name+'\\_L\\_'+label+'\\_'+not_value).removeClass('assigned');
                                        $('#suggestion\\_'+classifier_name+'\\_L\\_'+label+'\\_'+not_value).removeClass('suggested');
                                        $('#suggestion\\_'+classifier_name+'\\_L\\_'+label+'\\_'+not_value).addClass('not_relevant');
                                    }
                                });
                            });
                        }
                    }
                });
            }
        }

        function position_changed() {
            var position = parseInt($("#position").val());
            if(isNaN(position))
                position = 0;
            if(position>=datasetsize)
                position = datasetsize-1;
                $("#position").val(position);
            if(position<0)
                position = 0;

            $.ajax({
                type:'POST',
                url:'${dataset_path}/document_by_position',
                data: { name: dataset_name , position: position },
                dataType: 'json'})
            .done(function(msg) {
                $('#external-id').text(msg['external_id']);
                $('#uploaded').text(msg['created'].slice(0,-13));
                $('#textbox').val(msg['text']).trigger('input');
            });
        }

        function goto_first() {
                $('#position').val(0).change();
        }

        function goto_last() {
                $('#position').val(datasetsize-1).change();
        }

        function change_autobrowse() {
            autobrowse += 1;
            if(autobrowse>= autobrowsevalues.length)
                autobrowse = 0;
            $('#direction').text(autobrowsevalues[autobrowse][0]);
        }

        function reset_labels() {
            $('#suggestions > div > .name').each(function(i,item) {
                var classifier_name = $(item).text();
                classifier_name = classifier_name.substr(0,classifier_name.length - 1);
                $('#assignments\\_'+classifier_name).find('.scoreline').removeClass('assigned');
                $('#assignments\\_'+classifier_name).find('.scoreline').removeClass('suggested');
                $('#assignments\\_'+classifier_name).find('.scoreline').addClass('not_relevant');
            });
            $('#pool > div > .name').each(function(i,item) {
                var classifier_name = $(item).text();
                classifier_name = classifier_name.substr(0,classifier_name.length - 1);
                $('#assignments\\_'+classifier_name).find('.scoreline').removeClass('assigned');
                $('#assignments\\_'+classifier_name).find('.scoreline').removeClass('suggested');
                $('#assignments\\_'+classifier_name).find('.scoreline').addClass('not_relevant');
            });
        }

        function next_doc() {
            var classifier_name = null;
            var class_count = $('#suggestions > div > .name').length
            if(class_count>0) {
                classifier_name = $('#suggestions > div > .name')[Math.floor(Math.random() * class_count)].textContent;
                classifier_name = classifier_name.substr(0,classifier_name.length - 1)
            }
            if(autobrowsevalues[autobrowse][0]==browse_next) {
                var newposition = parseInt($("#position").val())+1;
                if(newposition<=datasetsize) {
                    $('#position').val(newposition).change();
                }
            }
            else if(autobrowsevalues[autobrowse][0]==browse_prev) {
                var newposition = parseInt($("#position").val())-1;
                if(newposition>=0) {
                    $('#position').val(newposition).change();
                }
            }
            if(autobrowsevalues[autobrowse][0]==browse_random) {
                if(classifier_name==null) {
                    $.ajax({
                        type:'POST',
                        url:'${dataset_path}/random_document_id',
                        data: { name: dataset_name , filter: $('#filter').val() },
                        dataType: 'json'})
                    .done(function(msg) {
                        var newposition = parseInt(msg);
                        $('#position').val(newposition).change();
                    })
                    .fail(function(errMsg) {
                        custom_alert(errMsg.responseText);
                    });
                }
                else {
                    $.ajax({
                        type:'POST',
                        url:'${dataset_path}/random_unlabeled_document_id',
                        data: { name: dataset_name , classifier_name: classifier_name, filter: $('#filter').val() },
                        dataType: 'json'})
                    .done(function(msg) {
                        var newposition = parseInt(msg);
                        $('#position').val(newposition).change();
                    })
                    .fail(function(errMsg) {
                        custom_alert(errMsg.responseText);
                    });
                }
            }
            else if(autobrowsevalues[autobrowse][0]==browse_diff) {
                if(classifier_name==null) {
                    $.ajax({
                        type:'POST',
                        url:'${dataset_path}/random_document_id',
                        data: { name: dataset_name , filter: $('#filter').val() },
                        dataType: 'json'})
                    .done(function(msg) {
                        var newposition = parseInt(msg);
                        $('#position').val(newposition).change();
                    })
                    .fail(function(errMsg) {
                        custom_alert(errMsg.responseText);
                    });
                }
                else {
                    $.ajax({
                        type:'POST',
                        url:'${dataset_path}/most_uncertain_document_id',
                        data: { name: dataset_name , classifier_name: classifier_name, filter: $('#filter').val() },
                        dataType: 'json'})
                    .done(function(msg) {
                        var newposition = parseInt(msg);
                        $('#position').val(newposition).change();
                    })
                    .fail(function(errMsg) {
                        custom_alert(errMsg.responseText);
                    });
                }
            }
            else if(autobrowsevalues[autobrowse][0]==browse_rnd) {
                var newposition = Math.floor(Math.random() * datasetsize);
                $('#position').val(newposition).change();
            }
        }

        function show_suggestions() {
            if($('#showsugg').is(':checked')) {
                $('#history').children().remove();
                $('#accuracy').text('n/a');
                $('#all\\_correct').show();
                $('#historybox').show();
                classify();
            }
            else {
                $('#suggestions div[id^=suggestions] .ui-widget-header').each(function(i,item) {
                    var classifier_name = $(item).children('.name').text();
                    $('#assignments\\_'+classifier_name).children('.scoreline').each(function(i,item) {
                        if($(item).hasClass('suggested')) {
                            $(item).removeClass('suggested');
                            $(item).addClass('not_relevant');
                        }
                    });
                });
                $('#all\\_correct').hide();
                $('#historybox').hide();
            }
        }

        function create_classifier() {
            var name = $("#create\\_name").val();
            if(!name.match(/^[a-zA-Z0-9_]+$/)) {
                custom_error("The name of the classifier can only contain letters, numbers and the underscore character '_'");
                return false;
            }
            var labelsString = $("#labels").val();
            if(!labelsString.match(/^[a-zA-Z0-9_,]+$/)) {
                custom_alert("The names of labels can only contain letters, numbers and the underscore character '_'");
                return false;
            }
            document.getElementById('create_classifier_button').style.display='none';
            document.getElementById('create_classifier_button_wait').style.display='block';
            var labels = labelsString.split(',');
            var type = $("#type").val();
            var data = {name: name, labels: labels, type: type} ;
            $.ajax({
                type: "POST",
                url: "${classifier_path}/create",
                data: data})
            .done(function() {
                document.getElementById('dia_create_classifier').style.display='none';
                document.getElementById('create_classifier_button').style.display='block';
                document.getElementById('create_classifier_button_wait').style.display='none';
                update();
            })
            .fail(function(errMsg) {
                document.getElementById('create_classifier_button').style.display='block';
                document.getElementById('create_classifier_button_wait').style.display='none';
                custom_error(errMsg.responseText);
            });
            return false;
        };

        function merge_classifiers() {
            var name = $("#merge\\_name").val();
            var binary_by_name = $("#merge\\_binary\\_by\\_name").is(':checked');
            if(!name.match(/^[a-zA-Z0-9_]+$/)) {
                custom_error("The name of the classifier can only contain letters, numbers and the underscore character '_'");
                return false;
            }
            document.getElementById('merge_classifier_button').style.display='none';
            document.getElementById('merge_classifier_button_wait').style.display='block';
            var sources = $("#comb\\_from").val()
            var mergetype = $("#mergetype").val();
            var data = {name: name, sources: sources, type:mergetype, binary_by_name:binary_by_name};
            $.ajax({
                type: "POST",
                url: "${classifier_path}/merge",
                data: data})
            .done(function() {
                document.getElementById('dia_merge_form').style.display='none';
                document.getElementById('merge_classifier_button').style.display='block';
                document.getElementById('merge_classifier_button_wait').style.display='none';
                update();
            })
            .fail(function(errMsg) {
                document.getElementById('merge_classifier_button').style.display='block';
                document.getElementById('merge_classifier_button_wait').style.display='none';
                custom_error(errMsg.responseText);
            });
            return false;
        };



        $( document ).ready(function() {
            var pathname = window.location.pathname;
            dataset_name = pathname.substring(pathname.lastIndexOf('/')+1)
            $('#datasetname').text(dataset_name);

            $('#direction').text(autobrowsevalues[autobrowse][0]);

            $("#textbox").on("keyup",function() {
                text = $("#textbox").val();
                if(text!=last_text) {
                    $('#external-id').text('n/a');
                    $('#uploaded').text('not from dataset');
                }
            });
            $("#textbox").on("input",function() {
                delay(function() {
                reset_labels();
                classify();
            },delay_interval);});

            $('#position').change(position_changed);

            $('#browse\\_autobrowse').click(change_autobrowse);

            $('#showsugg').change(show_suggestions);

            $('#filter').on('keydown', function (e) {
                if (e.keyCode == 13) {//enter
                    next_doc();
                }
            });

            $(document).on('keydown', function(e) {
                if(e.keyCode == 39 && e.target.id == '') {//right arrow
                    next_doc();
                }
            });

            $('#create\\_classifier').submit(create_classifier);
            $('#merge\\_form').submit(merge_classifiers);

            $('#comb\\_from').select2({
                placeholder: 'Select the classifiers to merge',
                allowClear: true,
                width: '100%'
            });

            $('#use').select2({
                placeholder: 'Select the classifiers to use',
                allowClear: true,
                width: '100%'
            });

            timed_update();
            goto_first();

        });
    </script>
</%block>

<%block name="menu2">
<section class="w3-navbar w3-theme-d4 ">
    <div id="but_create_classifier" class="w3-bar-item w3-button"
         onclick="document.getElementById('dia_create_classifier').style.display='block'">Create
        new classifier
    </div>
    <div id="but_merge_form" class="w3-bar-item w3-button"
         onclick="document.getElementById('dia_merge_form').style.display='block'">Copy/Merge classifiers
    </div>
</section>
</%block>

<section>
    <div class="w3-panel w3-padding">
        <div class="w3-card">
            <header class="w3-container w3-theme">
                <h4>Browse & code dataset <b><span id="datasetname">NULL</span></b>:</h4>
            </header>
            <form id="select_form" class="w3-container" action="#" method="post">
                    <p><label for="use">Classifiers to use:</label>
                    <select class="w3-select" multiple id="use" style="width:230px;">
                    </select></p>
                <p><label for="showsugg">Show labeling <span class="suggested">suggestions</span></label>
                    <input type="checkbox" id="showsugg" checked/>
                </p>
                <span id="browse_autobrowse">Order of presentation: <span id='direction' class="w3-button w3-text-theme w3-round">NULL</span></span>
            </form>
            <div class="w3-container">
                <div class="w3-tooltip w3-left">Current document: <input id='position' type="number" min=0 max=0 value=0>/<span id="size">NULL</span>
                    <div class="w3-text w3-theme w3-tag w3-small w3-round">
                        <div>ID: <span id="external-id">NULL</span></div>
                        <div>Uploaded: <span id="uploaded">NULL</span></div>
                    </div>
                </div>
                <div class="w3-right">Search: <input type="text" id="filter" placeholder="Text filter"/></div>
                <div class="w3-container"></div>
                <textarea id="textbox" class="w3-block w3-margin-top" placeholder="Text to code" style="height:33%;"></textarea>
                <div id="buttons" class="w3-container w3-panel"></div>
                <div id="suggestions" class="w3-container w3-margin-bottom"></div>
                <div id="pool" style="display:none;"></div>
                <div id="historybox">
                    <div class="w3-margin-bottom">Agreement on last <input id="histsize" type="number" min="10" max="500" value="50"> assigned labels: <span id="accuracy">n/a</span></div>
                    <div class="w3-margin-bottom">Agreement history: <div id="history"></div></div>
                </div>
            </div>
        </div>
    </div>
    <div id="dia_create_classifier" class="w3-modal">
        <div class="w3-modal-content w3-card-4">
            <header class="w3-container w3-theme">
                <span
                        onclick="document.getElementById('dia_create_classifier').style.display='none'"
                        class="w3-button w3-display-topright">&times;</span>
                <h3 class="w3-theme">Create classifier</h3>
            </header>
            <form id="create_classifier" class="w3-container" action="#" method="post">
                <p>
                    <label for="create_name">Name:</label>
                    <input class="w3-input" type="text" id="create_name"/></p>
                <p>
                    <label for="labels">Labels (comma separated):</label>
                    <input class="w3-input" type="text" id="labels"/></p>
                <p>
                    <label for="type">Type:</label>
                    <select class="w3-select" id="type">
                        <%! from db import sqlalchemydb %>
                        % for classifier_type in sqlalchemydb.CLASSIFIER_TYPES:
                        <option value="${classifier_type}">${classifier_type}</option>
                        % endfor
                    </select></p>
                <p>
                    <input class="w3-input" id="create_classifier_button" type="submit" value="Create"/>
                    <span class="w3-center" id="create_classifier_button_wait" style="display:none">Processing</span>
                </p>
            </form>
        </div>
    </div>
    <div id="dia_merge_form" class="w3-modal">
        <div class="w3-modal-content w3-card-4">
            <header class="w3-container w3-theme">
                <span
                        onclick="document.getElementById('dia_merge_form').style.display='none'"
                        class="w3-button w3-display-topright">&times;</span>
                <h3 class="w3-theme">Copy/Merge classifiers</h3>
            </header>
            <form id="merge_form" class="w3-container" action="#" method="post">
                <p>
                    <label for="merge_name">Name:</label>
                    <input class="w3-input" type="text" id="merge_name"/></p>
                <p>
                    <label for="comb_from">From:</label>
                    <select class="w3-select" multiple id="comb_from" style="width:230px;">
                    </select></p>
                <p>
                    <label for="merge_binary_by_name">Merge binary classifiers by name</label>
                    <input type="checkbox" id="merge_binary_by_name" checked/>
                </p>
                <p>
                    <label for="mergetype">Type:</label>
                    <select class="w3-select" id="mergetype">
                        <%! from db import sqlalchemydb %>
                        % for classifier_type in sqlalchemydb.CLASSIFIER_TYPES:
                        <option value="${classifier_type}">${classifier_type}</option>
                        % endfor
                    </select></p>
                <p>
                    <input class="w3-input" id="merge_classifier_button" type="submit" value="merge"/>
                    <span class="w3-center" id="merge_classifier_button_wait" style="display:none">Processing</span>
                </p>
            </form>
        </div>
    </div>
</section>
